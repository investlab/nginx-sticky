###############################
# BLOCK SQL INJECTIONS
###############################
set $block_sql_injections 0;

# Union-based
if ($query_string ~* "(?i)(union(\s|%20|/\*|\+)*select)") {
	set $block_sql_injections 1;
}
# SELECT-FROM pattern
if ($query_string ~* "(?i)select(\s|%20|/\*|\+)+[^\s]+(\s|%20|/\*|\+)+(from|where)") {
	set $block_sql_injections 1;
}
# Common keywords
if ($query_string ~* "(?i)(information_schema|sleep\(|benchmark\(|load_file\(|outfile)") {
	set $block_sql_injections 1;
}
# Function injection
if ($query_string ~* "(?i)(concat|group_concat|char|ascii|hex|unhex)\s*\(") {
	set $block_sql_injections 1;
}
# SQL comment injection
if ($query_string ~* "(--|#|/\*)") {
	set $block_sql_injections 1;
}
# Obfuscated equals or quotes
if ($query_string ~* "(%3D|=).*(%27|'|%22|\")") {
	set $block_sql_injections 1;
}

if ($block_sql_injections = 1) {
	return 403;
}

###############################
# BLOCK FILE INCLUSIONS
###############################
set $block_file_injections 0;

# External URLs
if ($query_string ~* "(?i)[a-zA-Z0-9_]+=http(s)?%3A%2F%2F") {
	set $block_file_injections 1;
}
# Directory traversal
if ($query_string ~* "(?i)(\.\./|\.\.%2F|%2E%2E%2F)+") {
	set $block_file_injections 1;
}
# Unix paths
if ($query_string ~* "(?i)/etc/passwd|/proc/self/environ") {
	set $block_file_injections 1;
}

if ($block_file_injections = 1) {
	return 403;
}

###############################
# BLOCK COMMON EXPLOITS / XSS
###############################
set $block_common_exploits 0;

# Basic script tags and encoded form
if ($query_string ~* "(?i)(<|%3C)\s*script.*(>|%3E)") {
	set $block_common_exploits 1;
}
# PHP global vars
if ($query_string ~* "(?i)(GLOBALS|_REQUEST|_GET|_POST)(=|\[|%5B|%3D)") {
	set $block_common_exploits 1;
}
# Base64 patterns
if ($query_string ~* "(?i)base64_(en|de)code\s*\(") {
	set $block_common_exploits 1;
}

if ($block_common_exploits = 1) {
	return 403;
}

###############################
# BLOCK SPAM KEYWORDS
###############################
set $block_spam 0;

if ($query_string ~* "(?i)\b(viagra|cialis|levitra|phentermin|tramadol|xanax|valium|ambien|ultram|lipitor|prozac|erection|libido|ejaculation|hoodia|cocaine)\b") {
	set $block_spam 1;
}

if ($block_spam = 1) {
	return 403;
}

###############################
# BLOCK USER AGENTS
###############################
set $block_user_agents 0;

# Bots, crawlers, bandwidth hoggers
if ($http_user_agent ~* "(Indy Library|libwww-perl|GetRight|GetWeb!|Go!Zilla|Download Demon|Go-Ahead-Got-It|TurnitinBot|GrabNet)") {
	set $block_user_agents 1;
}

if ($block_user_agents = 1) {
	return 403;
}

